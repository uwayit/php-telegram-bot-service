# Запрет выдачи листинга пустого каталога
Options -Indexes +SymLinksIfOwnerMatch
AddDefaultCharset utf-8
DirectoryIndex index.php
RewriteEngine On
# Убирает дубль главной
RewriteCond %{THE_REQUEST} ^[A-Z]{3,9}\ /index\.php
RewriteRule ^index\.php$ / [L,R=301]
# Убирает дубль сайта (www)
#RewriteBase /
#RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
#RewriteRule ^(.*)$ http://%1/$1 [R=301,L]
# Если нужна переадресация с http на httpS
#RewriteCond %{HTTPS} =off  [OR]
#RewriteCond %{SERVER_PORT} !^443$
#RewriteRule .* https://%{SERVER_NAME}%{REQUEST_URI} [R,L]
# Если какого-то хрена нужна переадресация с httpS на http, то:
# в варианте №1 меняем =off на =on
# в варианте №2 меняем !^443$ на ^443$
# и вместо последней строчки включаем:
# RewriteRule ^(.*)$ http://%{SERVER_NAME}%{REQUEST_URI} [R=301,L]
# То есть делаем так
# RewriteCond %{HTTPS} =on  [OR]
# RewriteCond %{SERVER_PORT} ^443$
# RewriteRule ^(.*)$ http://%{SERVER_NAME}%{REQUEST_URI} [R=301,L]



# ----------------------------------------------------------------------
# Закриваємо доступ до всіх файлів та папок що починаються з крапки окрім well-known
# ----------------------------------------------------------------------
RewriteRule "(^|/)\.(?!well-known\/)" - [F]
# ----------------------------------------------------------------------
# Запрещен доступ посетителей к важным файлам и zip архивам
# ----------------------------------------------------------------------
<Files MysqlConnection.php>
  deny from all
</Files>
<Files load.php>
  deny from all
</Files>
<Files "\.(zip|txt|sql)$">
Deny from all
</Files>
# ----------------------------------------------------------------------
# Блокируем некоторые эксплоиты
# ----------------------------------------------------------------------
## Если у вас появились проблемы, закомментируйте данные правила
#
RewriteCond %{QUERY_STRING} mosConfig_[a-zA-Z_]{1,21}(=|\%3D) [OR]
# Блокируем возможность посылать base64_encode через URL
RewriteCond %{QUERY_STRING} base64_encode.*\(.*\) [OR]
# Блокируем передачу тега <script> через URL
RewriteCond %{QUERY_STRING} (<|%3C)([^s]*s)+cript.*(>|%3E) [NC,OR]
# Блокируем выставление переменной PHP GLOBALS через URL
RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
# Блокируем возможность изменять переменную _REQUEST через URL
RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2})
# Посылаем все заблокированные запросы на домашнюю страницу с ошибкой 403 Forbidden error!
RewriteRule ^(.*)$ index.php [F,L]
########### [Конец] Блокируем некоторые эксплоиты


# ----------------------------------------------------------------------
# Еще немножко безопасности
# ----------------------------------------------------------------------
# Чтобы не показывать точную версию Apache в заголовках
ServerSignature Off

# добавьте следующее в httpd.conf (это нельзя сделать в .htaccess)
#    ServerTokens Prod

# ----------------------------------------------------------------------
# Сжатие страниц и траффика
# Конфигурируется только в режиме mod_php
# В режиме fastCGI - php конфигить не выйдет
# Благодаря конструкции ifModule сервер не выпадет в ошибку 500
# если данного модуля нет или он не конфигурируется из под htaccess
# ----------------------------------------------------------------------
<ifModule mod_deflate.c>
AddOutputFilterByType DEFLATE text/html text/plain text/xml application/xml application/xhtml+xml text/css text/javascript application/javascript application/x-javascript
</ifModule>
<IfModule mod_gzip.c>
 	mod_gzip_on         Yes
 	mod_gzip_dechunk    Yes
 	mod_gzip_item_include file		\.(html?|txt|css|js|php|pl)$
 	mod_gzip_item_include mime		^text\.*
 	mod_gzip_item_include mime		^application/x-javascript.*
 	mod_gzip_item_exclude mime		^image\.*
 	mod_gzip_item_exclude rspheader	^Content-Encoding:.*gzip.*
</IfModule>


# ----------------------------------------------------------------------
# Кеширование файлов на стороне клиента
# Конфигурируется только в режиме mod_php
# В режиме fastCGI - php конфигить не выйдет
# Благодаря конструкции ifModule сервер не выпадет в ошибку 500
# если данного модуля нет или он не конфигурируется из под htaccess
# ----------------------------------------------------------------------
<ifModule mod_headers.c>
	#кэшировать html и htm файлы на 12 часов
	<FilesMatch "\.(html|htm)$">
		Header set Cache-Control "max-age=43200"
	</FilesMatch>
	#кэшировать флэш и изображения на неделю
	# Изображения с раширением jpeg на сайте ОТСУСТСТВУЮТ И БЫТЬ ИХ НЕ ДОЛЖНО
	# Расширение jpeg используется как php
	<FilesMatch "\.(flv|swf|ico|gif|jpg|png)$">
		Header set Cache-Control "max-age=604800"
	</FilesMatch>
</IfModule>
<ifModule mod_expires.c>
	ExpiresActive On
	#кэшировать флэш и изображения на месяц
	ExpiresByType image/x-icon "access plus 2592000 seconds"
	ExpiresByType image/jpeg "access plus 2592000 seconds"
	ExpiresByType image/png "access plus 2592000 seconds"
	ExpiresByType image/gif "access plus 2592000 seconds"
	ExpiresByType application/x-shockwave-flash "access plus 2592000 seconds"
</ifModule>



# ----------------------------------------------------------------------
# Интересный трюк
# ----------------------------------------------------------------------
# позволяет серверу читать файлы с описанным расширением как php скрипты
# например можно сделать так http://credit.net/credit.credit
# AddHandler application/x-httpd-php .credit
# Также эту уловку можно сделать для нашего пикселя отслеживания
# AddHandler application/x-httpd-php .jpeg
# Кстати существует другой вариант где не AddHandler, а AddType
# AddType application/x-httpd-php .jpeg

# ----------------------------------------------------------------------
# Позволяет обрабатывать реферальные ссылки И устанавливать язык сайта
# ----------------------------------------------------------------------
# RewriteCond $1 !^(vip.php)
# RewriteCond $1 !^(index.php)
# RewriteCond $1 !^(robots.txt)
# RewriteRule ^(.*)$ index.php?yes=$1 [L]
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-f
# первый символ и те символы которые остаются в get A-Za-z0-9
# учитываются только символы до первого некорректного
# враховується також / бо я намагаюсь створити універсальну точку входу
RewriteRule ^([A-Za-z0-9/_]+)/? index.php?yes=$1 [QSA,L]
# первый символ и те символы которые остаются в get 0-9
# RewriteRule ^([0-9]+)? index.php?yes=$1 [QSA,L]

# Deny accessing dot files
RewriteRule (^\.|/\.) - [F]
RewriteRule (^\.|/\.) - [F]
