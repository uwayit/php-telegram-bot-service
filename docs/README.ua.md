# php telegram api bot easy FULL

### Сумісність
Цей код перевірено на роботу з PHP 8.1.  
Він також може бути сумісний із PHP 5.6, хоча це не гарантовано.

[README in english](../docs/README.en.md)  

Повний набір бібліотек, класів та функцій, необхідних для створення функціонального процедурного Telegram-бота, який вільний від будь яких зовнішніх залежностей

## Ключові переваги: 
1. Невисокий поріг входу (junior friendly) завдяки простому та гарно прокоментованому коду
2. Функціональність та гнучкість

Бот який Ви отримаєте одразу з коробки після [інсталяції](../docs/README.ua.md#full-bot)  
[можна протестувати тут](https://t.me/TestHostingUa_bot)  

**Зверніть увагу!** Через візуальне тестування Ви НЕ зможете осягнути всіх можливостей боту.  

**Він вміє НЕ тільки:**
- працювати з повідомленнями та командами;  
- керувати профілем користувача та надавача послуг (продавця);  
- гнучко керувати містами надання послуг та продажу товарів;  
- веріфікувати номер телефону;  
- працювати з кнопками.  

**Додатково бот:**  
- захищений від ін'єкцій;  
- має антиспам захист та блекліст (mute and block);  
- може мовчати в визначених чатах (навіть в приватних);  
- може недопускати відправки користувачам якихось повідомлень надто часто;  
- може тримати контекст;  
- має тестовий режим в якому перемикається на sql таблиці з префіксом *_test;  
- в залежності від країни боту чи користувача, обирає мову для відповідей;  
- може бути частиною сайту (веріфікувати для сайту телефон тощо);  
- Коли місто тимчасово під окупацією чи в зоні лиха, його можна тимчасово приховати;  
- якщо група стала супергрупою (а отже змінився chat_id групи), вміє автоматично преадресовувати повідомлення на новий id і змінювати chat_id в базі на новий;  
- редагувати повідомлення в каналах (наприклад додавати кнопки);  
- можна створювати ролі користувачів в чатах (адмін,модератор тощо);  
- відправляти повідомлення про помилки та винятки в slack або в tg девелоперу;  
- логувати для зручності відладки всі вхідні дані та відповіді від tg API;  
- один hook може використовуватись для десятків різноманітних за функціоналом ботів;  

**Також він може з легкістю модерувати публічні чати:**
- автоматично видаляє нав'язливі повідомлення про те що хтось вступ в чат або видалився з нього;  
- може митево видаляти спам повідомлення (з посиланнями);  
- може митево видаляти повідомлення в яких є наприклад нецензурна лексика (з вашого списку);  
- про порушення правил користувачами, бот може повідомити в особисті, а також вести відлік кількості порушень, та їх регулярності. Злісних порушників бот може блокувати як на рівні телеграм API так і на рівні системи (для всіх чатів які обслуговує бот).

Приклад стартового та повністю робочого файлу **hook** можна знайти в 
**bots/base_hook.php**  
**hook** повноцінно насичений коментарями з поясненням кожного рядка  

**Якщо вам ЛИШЕ потрібен клас**, який працює з API Telegram, і ви самостійно розроблятимете функціональні можливості бота, то все, що вам потрібно, це один файл:  

/lib/tgBot.php  

**Приклади використання базового class tgBot:**  
```php
// Connection base class
include_once $_SERVER['DOCUMENT_ROOT'] . "/lib/tgBot.php";
// Get the bot object
// Вкажіть токен від botfather та ім’я бота
$bot = new tgBot($token, $name);

// Якщо вам ЛИШЕ потрібен клас, то потрібно при кожному отриманні об'єкта активувати
$bot->liteModeOn();

// АБО ЩОБ ЦЬОГО НЕ РОБИТИ КОЖЕН РАЗ, ТО В САМОМУ КЛАСІ (!) tgBot:
// public $FullMode = false;

// Бан користувача, наприклад, до 2048 року (unix)
$bot->tempban($user, '2473401362');

// chat_id|from_id отримувача повідомлення
$bot->for($chat_id);

// Видаляємо підготовлену клавіатуру та всі попередні keyboard кнопки що відображаються користувачу
$bot->deleteKeyboard();
// Визначаємо тип нової клавіатури
$bot->setupTypeKeyboard('inline'); // or keyboard or remove_keyboard
// Додаємо кнопку
$bot->insertButton([['text' => "підтвердити", 'callback_data' => 'make_ok']]);

/* 
Раніше додана клавіатура видаляється автоматично після відправки повідомлення,
тож для нового повідомлення її потрібно вказувати знову або якщо потрібно зберегти клавіатуру, 
то ДО відправки КОЖНОГО повідомлення можна вказати: 
*/
$bot->clearKeyboardAfterSend = false;
// Send message
// Після відправки ми зможемо розібрати масив $response з відповідю
$response = $bot->reply("Hello World");
```

Більше документації з приводу можливостей класу можна знайти в коментарях безпосередньо в lib/tgBot  


## Full bot  
**Бот може стати безкінечно функціональним, якщо підключити його до MySQL та трохи налаштувати**  

Повноцінно інстальований бот здатний:
1. Зберігати унікальні для кожного боту налаштування (країну, адміністраторів, модераторів, контакти, сайт, ключовий tg канал тощо)
2. Пам'ятати користувачів та їх дані (контакти, піб, баланс, статус тощо)
3. Надавати користувачам різні ролі та відповідні можливості (адміністратор, модератор)
4. Надавати послуги, консультації або продавати товари
5. Пам'ятати останній важливий контекст діалогу (наприклад коли бот запитав номер телефону, він продовжує його чекати не дивлячись на помилки користувача)
6. Автоматично додавати до постів на каналах кнопки чи посилання
7. Впроваджувати обмежений доступ до чатів (по підписці наприклад)
8. Автоматично виконувати дії в залежності від відповіді отриманої від Telegram API  
9. В залежності від країни бота або мови користувача, бот може обирати якою мовою відправляти повідомлення. Базово в бот закладена можливість вказути варіанти повідомлень на українській, англійській та російській (для десятків країн з великою російськомовною аудиторією).  


**Для інсталяції, а отже отримання full боту потрібно:**  
1. Завантажити весь репозиторій
2. В кореневому файлі MysqlConnection.php вказати дані для доступу до бази данних
3. Змінити константи на свій смак в load.php (EMAIL,SERVICE_KEY,SERVICE_KEY_SOLD,SECURITY,SLACK,$SlackSet,tgdevId);
4. Виконати install.php та слідувати його інструкціям
5. Set webhook **bots/base_hook.php** [faq](../docs/setWebhook.ua.md)
6. Зверніть увагу на заборони та правила в кореневому та інших .htaccess

**Що саме встановлюється в базу данних для функціонування розширенного боту?**  
Перелік та деталі країн (table countries) з якими бот вже готовий функціонально працювати. Наразі додано 11 країн (Україна, Great Britain, Казахстан, Грузія, Латвія, Узбекістан, Таджикістан, Білорусь, Молдова, Арменія, Киргизстан);  
База містить перелік областей вищезазначених країн та всіх міст в яких проживає більше 3-7 тисяч (table regions) жителів. Це дозволяє з коробки повноцінно надавати послуги або продавати товари в цих містах;  
Також встановлюються таблиці необхідні для зберігання профілів користувачів, їх замовлень, налаштування ботів, логування діалогу з користувачами, а також логування та опрацювання помилок, винятків та спаму.  


**Логування запитів**
По замовчуванню кожен запит для зручного дебагінгу логується в текстові файли в папку bots/nameBot/  
Для відключення логування **вхідних** закоментуйте в bots/*_hook.php рядок $bot->botLog(...);  
Для відключення логування **вихідних** закоментуйте в lib/tgBot.php у функції request() рядок $bot->botLog(...);  

**Дуже рекомендую обов'язково відключити логування після дебагінгу**  

## Poadmap
1. Прив'язка користувачами email та можливість комунікації з ними по пошті
2. Доступ користувачів до чату по підписці
3. Додавання послуг, підписок, QR квитків чи товарів (в першу чергу, управління послугами та товарами буде виконуватись через візуальний інтерфейс phpMyAdmin)
4. Сплата послуги, підписки, QR квитків чи товару по номеру картки (полуавтоматичний p2p) чи на BTC використовуючи унікальний холодний автоматичний процесінг платежів (нода не потрібна)!

## Notice
Мною поки НЕ планується створення будь якого функціонального візуального (tg or web) інтерфейсу для керування та налаштування бота окрім вже реалізованих.  

Я надаю коробку якісно задокументованих готових рішеннь (класси, функції та методи) комбінуючи які,  виходячи з особистих потреб, можна зробити дуже функціональний бот, але робити це доведеться, через конструювання в php коді та налаштуванні через MySQL базу данних (PhpMyAdmin).  